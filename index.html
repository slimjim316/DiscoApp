<!doctype html>
<html>
<head>
<meta charset="utf-8">
<meta name="viewport" content="width=device-width,initial-scale=1">
<title>DiscoApp Â· Library</title>
<style>
  :root{ --bg:#ffffff; --text:#111111; --muted:#6b6b6b; --hair:#e6e6e6; --red:#ff3b30; --tile:#f5f5f7; --bar:#0a84ff; }
  *{box-sizing:border-box} html,body{height:100%}
  body{ margin:0; background:var(--bg); color:var(--text);
    font-family:-apple-system,BlinkMacSystemFont,"Segoe UI",Roboto,Helvetica,Arial,sans-serif;
    -webkit-font-smoothing:antialiased; text-rendering:optimizeLegibility; }

  /* Version tag */
  .version-tag {
    position: fixed; top: 6px; right: 10px;
    font-size: 12px; color: var(--muted); opacity: .6;
    user-select: none; z-index: 50;
  }

  header{ position:sticky; top:0; z-index:10; background:var(--bg); padding:8px 12px 6px; border-bottom:1px solid var(--hair); }
  .title{font-size:28px;font-weight:700;margin:8px 2px 10px}
  .search{ display:flex; align-items:center; gap:8px; background:var(--tile); border:1px solid var(--hair); padding:10px 12px; border-radius:12px; }
  .search input{flex:1;border:0;background:transparent;outline:none;font-size:16px;color:var(--text)}
  .search .mag{opacity:.6}
  .info{display:flex;justify-content:space-between;align-items:center;font-size:13px;color:var(--muted);padding:8px 2px 6px}
  .info-right{display:flex;gap:12px;align-items:center}
  .progress-wrap{width:180px;height:6px;border-radius:999px;background:var(--hair);overflow:hidden}
  .progress-bar{height:100%;width:0%;background:var(--bar);transition:width .25s ease; }
  main{padding:10px 10px 90px}

  /* Grid cards */
  .grid{ display:flex; flex-wrap:wrap; margin:-6px; }
  .card{ width:20%; padding:6px; }
  .cardInner{ background:var(--bg); border:1px solid var(--hair); border-radius:12px; overflow:hidden; cursor:pointer; display:flex; flex-direction:column; height:100%;}
  .artWrap{position:relative;width:100%;padding-top:100%;background:#ddd;border-bottom:1px solid var(--hair)}
  .art{position:absolute;left:0;top:0;width:100%;height:100%;object-fit:cover;background:#ddd}
  .meta{padding:8px 10px;min-height:56px}
  .t{font-weight:700;font-size:14px;line-height:1.25;white-space:nowrap;overflow:hidden;text-overflow:ellipsis}
  .s{margin-top:2px;font-size:12px;color:var(--muted);white-space:nowrap;overflow:hidden;text-overflow:ellipsis}
  @media (max-width:1024px){ .card{width:25%} }
  @media (max-width:820px) { .card{width:33.3333%} }
  @media (max-width:600px) { .card{width:50%} }
  @media (max-width:380px) { .card{width:100%} }

  /* List rows */
  .list{list-style:none; padding:0; margin:0; display:none;}
  .row{display:flex; align-items:center; padding:10px 12px; border-bottom:1px solid var(--hair); cursor:pointer}
  .thumbWrap{position:relative; width:64px; height:64px; border-radius:8px; overflow:hidden; background:#ddd; margin-right:12px}
  .thumb{position:absolute; left:0; top:0; width:100%; height:100%; object-fit:cover; background:#ddd}
  .metaL{min-width:0}
  .tL{font-weight:700;font-size:16px;line-height:1.2;white-space:nowrap;overflow:hidden;text-overflow:ellipsis}
  .sL{margin-top:2px;font-size:13px;color:var(--muted);white-space:nowrap;overflow:hidden;text-overflow:ellipsis}

  /* Toolbar */
  .toolbar{ position:fixed; left:0; right:0; bottom:0; background:var(--bg); border-top:1px solid var(--hair);
    display:flex; gap:8px; align-items:center; justify-content:space-between; padding:10px 12px; }
  .group{display:flex; gap:8px; align-items:center}
  .btn{ border:1px solid var(--hair); background:var(--tile); color:var(--text); padding:8px 12px; border-radius:10px; font-size:15px; cursor:pointer }
  .btn:disabled{opacity:.5; cursor:not-allowed}
  .accent{border-color:var(--red); color:#fff; background:var(--red)}
  .select{ border:1px solid var(--hair); background:var(--tile); color:var(--text); padding:8px 28px 8px 12px; border-radius:10px; font-size:15px; cursor:pointer; appearance:none;
    background-image:linear-gradient(45deg,transparent 50%,#666 50%),linear-gradient(135deg,#666 50%,transparent 50%);
    background-position:calc(100% - 18px) 16px, calc(100% - 12px) 16px; background-size:6px 6px; background-repeat:no-repeat;}

  /* ===== Details sheet ===== */
  .modal{position:fixed; left:0; right:0; top:0; bottom:0; background:rgba(0,0,0,.35); display:flex; align-items:flex-end; justify-content:center}
  .modal.hidden{display:none}
  .sheet{ width:100%; max-width:980px; background:var(--bg); border-radius:16px 16px 0 0; border:1px solid var(--hair); border-bottom:0; max-height:90vh; overflow:auto; box-shadow:0 -10px 30px rgba(0,0,0,.15); }
  .drag{width:48px;height:5px;border-radius:999px;background:var(--hair);margin:8px auto}
  #md-body{padding:14px 16px 22px 16px}

  .md-head{display:flex; gap:18px; align-items:stretch; margin-bottom:6px;}
  .md-art{flex:0 0 300px; border-radius:12px; overflow:hidden; background:#ddd; border:1px solid var(--hair)}
  .md-art img{width:100%; height:100%; object-fit:cover; background:#ddd}
  .md-info{min-width:0; flex:1}
  .md-title{font-size:24px; font-weight:800; margin:2px 0 6px 0}
  .md-artist{ color: var(--red); font-size:24px; font-weight:800; margin:2px 0 10px 0; }

  .md-lines{ margin:0 0 12px 0; }
  .md-lines .line{ font-size:14px; color:var(--text); margin:4px 0; }
  .md-lines .muted{ color:var(--muted); margin-right:6px; }

  .md-actions{display:flex; gap:8px; flex-wrap:wrap; margin:10px 0 0 0}
  .pill{display:inline-block; padding:8px 12px; border:1px solid var(--hair); background:var(--tile); border-radius:10px; font-size:14px; user-select:none; text-decoration:none}
  .pill.accent{border-color:var(--red); background:var(--red); color:#fff; cursor:pointer; text-decoration:none}

  .tracks{list-style:none; padding:0; margin:10px 0 0 0}
  .tr{display:flex; align-items:center; gap:10px; padding:10px 6px; border-bottom:1px solid var(--hair)}
  .tr .no{width:22px; text-align:right; color:var(--muted); font-variant-numeric:tabular-nums}
  .tr .twrap{min-width:0; flex:1}
  .tr .name{font-size:15px; white-space:nowrap; overflow:hidden; text-overflow:ellipsis}
  .tr .dur{width:44px; text-align:right; font-variant-numeric:tabular-nums; color:var(--muted)}

  @media (max-width:680px){
    .md-head{flex-direction:column; align-items:center; text-align:center}
    .md-art{ width:60%; height:auto; }
    .md-art img{ width:100%; height:auto; }
    .md-actions{justify-content:center}
  }
</style>
</head>
<body>

<div class="version-tag">v1.04b</div>

<header>
  <div class="title">Library</div>
  <div class="search">
    <span class="mag">ðŸ”Ž</span>
    <input id="q" placeholder="Artists, albums, catalog #, year" autocomplete="off">
  </div>
  <div class="info">
    <span id="count">0 items</span>
    <div class="info-right">
      <span id="progressTxt">Master years: 0 / 0 (0 active)</span>
      <div class="progress-wrap" aria-hidden="true"><div id="progressBar" class="progress-bar"></div></div>
      <span id="page">Page 1</span>
    </div>
  </div>
</header>

<main>
  <div id="grid" class="grid" aria-live="polite" style="display:block;"></div>
  <ul id="list" class="list" aria-live="polite"></ul>
</main>

<div class="toolbar">
  <div class="group">
    <button id="prev" class="btn">â—€ï¸Ž Prev</button>
    <button id="next" class="btn">Next â–¶ï¸Ž</button>
    <button id="random" class="btn accent">ðŸŽ² Random</button>
  </div>
  <div class="group">
    <select id="pageSize" class="select" title="Items per page">
      <option value="25">Show 25</option>
      <option value="50">Show 50</option>
      <option value="100" selected>Show 100</option>
      <option value="250">Show 250</option>
    </select>
    <button id="toggle" class="btn">List View</button>
  </div>
</div>

<!-- Details sheet -->
<div id="modal" class="modal hidden" aria-hidden="true">
  <div class="sheet" role="dialog" aria-modal="true" aria-labelledby="md-album-title">
    <div class="drag"></div>
    <div id="md-body"></div>
  </div>
</div>

<script>
(function(){
  /* ---------- CONFIG ---------- */
  var API  = "https://disco.slimjim316.workers.dev";
  var USER = "slimjim316";

  /* ---------- STATE ---------- */
  var page=1, per=100, folder=0, total=0, pages=1, q="", view="grid";
  var allItems = [];
  var filteredItems = [];

  var PER_KEY = 'discoapp_per_page';

  (function restorePer(){
    var saved = parseInt(localStorage.getItem(PER_KEY) || '100', 10);
    if([25,50,100,250].indexOf(saved) === -1) saved = 100;
    per = saved;
    var sel = document.getElementById('pageSize');
    if(sel){ sel.value = String(per); }
  })();

  /* ---------- AJAX (ES5) ---------- */
  function get(url, cb){
    var x=new XMLHttpRequest();
    x.open("GET", url, true);
    try { x.setRequestHeader('Accept','application/json'); } catch(e){}
    x.onreadystatechange=function(){
      if(x.readyState===4){
        if(x.status>=200 && x.status<300){
          var json=null, err=null;
          try{ json = JSON.parse(x.responseText); }
          catch(e){ err = new Error("Bad JSON from API"); }
          cb(err, json);
        }else{
          cb(new Error("HTTP "+x.status+" on "+url));
        }
      }
    };
    x.onerror=function(){ cb(new Error("Network/CORS error on "+url)); };
    x.send();
  }

  /* ---------- Utils ---------- */
  function isArray(x){ return Object.prototype.toString.call(x) === '[object Array]'; }
  function escapeHtml(s){ return String(s).replace(/[&<>"']/g,function(m){return {'&':'&amp;','<':'&lt;','>':'&gt;','"':'&quot;',"'":'&#39;'}[m];}); }
  function openModal(){ var m=document.getElementById("modal"); m.className="modal"; m.setAttribute("aria-hidden","false"); }
  function closeModal(){ var m=document.getElementById("modal"); m.className="modal hidden"; m.setAttribute("aria-hidden","true"); document.getElementById("md-body").innerHTML=""; }
  function validYear(y){ var n=parseInt(y,10); return (n>=1000 && n<=3000) ? n : null; }

  /* ---------- Master-year cache ---------- */
  var MASTER_YEAR = {};
  try { MASTER_YEAR = JSON.parse(localStorage.getItem('discoapp_master_year') || '{}') || {}; } catch(e){ MASTER_YEAR = {}; }
  function saveMasterYearCache(){ try { localStorage.setItem('discoapp_master_year', JSON.stringify(MASTER_YEAR)); } catch(e){} }

  var MASTER_INFLIGHT = {};

  /* ---------- Sorting helpers ---------- */
  function normalizeArtist(name){ if(!name) return ""; var s=String(name).replace(/^\s*the\s+/i,""); return s.toLowerCase(); }
  function isVarious(name){ return /^\s*various\s*$/i.test(name||""); }

  function parseYearFromMaster(data){
    if(!data) return null;
    if(typeof data.year === "number") return validYear(data.year);
    if(typeof data.year === "string" && /^\d{4}$/.test(data.year)) return validYear(+data.year);
    var r = data.released || data.released_date || "";
    var m = /^(\d{4})/.exec(r);
    return m ? validYear(+m[1]) : null;
  }

  /* ---------- Queue ---------- */
  var CONCURRENCY = 6, inflight = 0, queue = [], tickTimer=null;
  function runQueue(){ while(inflight<CONCURRENCY && queue.length){ var job=queue.shift(); inflight++; job(function(){ inflight--; updateProgress(); runQueue(); }); } }

  function fetchMaster(masterId, masterUrl, cb){
    if(!masterId){ cb(null,null); return; }
    if(MASTER_YEAR.hasOwnProperty(masterId)){ cb(null, MASTER_YEAR[masterId]); return; }
    if(MASTER_INFLIGHT[masterId]){ cb(null,null); return; }
    MASTER_INFLIGHT[masterId] = true;

    var urls = []; if(masterUrl) urls.push(masterUrl);
    urls.push("https://api.discogs.com/masters/" + encodeURIComponent(masterId));

    queue.push(function(done){
      var urlIdx=0, attempt=0;
      function tryNext(){
        if(urlIdx>=urls.length){ delete MASTER_INFLIGHT[masterId]; done(); cb(null,null); return; }
        var u=urls[urlIdx];
        get(u, function(err, data){
          var y = !err ? parseYearFromMaster(data) : null;
          if(!err && y!=null){
            MASTER_YEAR[masterId]=y; saveMasterYearCache();
            delete MASTER_INFLIGHT[masterId]; done(); cb(null,y);
          }else{
            attempt++; if(attempt<3){ setTimeout(tryNext, attempt*600); } else { urlIdx++; attempt=0; tryNext(); }
          }
        });
      }
      tryNext();
    });
    updateProgress(); runQueue();
  }

  function wantMasters(items){ var list=[], seen={}; for(var i=0;i<items.length;i++){ var m=items[i].master_id; if(m && !seen[m]){ seen[m]=1; list.push({id:m, url:items[i].master_url}); } } return list; }

  function fillMasterYears(items, onDone){
    var all=wantMasters(items), pending=[], i;
    for(i=0;i<all.length;i++){ var m=all[i].id; if(!MASTER_YEAR.hasOwnProperty(m) && !MASTER_INFLIGHT[m]) pending.push(all[i]); }
    if(!pending.length){ updateProgress(); if(onDone) onDone(); return; }
    var left=pending.length;
    for(i=0;i<pending.length;i++){ (function(mid,murl){ fetchMaster(mid,murl,function(){ left--; if(left===0){ updateProgress(); if(onDone) onDone(); } }); })(pending[i].id, pending[i].url); }
    updateProgress();
  }

  function cmpItems(a,b){
    if(a.normArtist < b.normArtist) return -1;
    if(a.normArtist > b.normArtist) return 1;
    if(a.isVarious && b.isVarious){
      var at=(a.title||"").toLowerCase(), bt=(b.title||"").toLowerCase();
      if(at<bt) return -1; if(at>bt) return 1; return 0;
    }
    var am = (a.master_year!=null ? a.master_year : (a.year!=null ? a.year : null));
    var bm = (b.master_year!=null ? b.master_year : (b.year!=null ? b.year : null));
    if(am!=null && bm!=null && am!==bm) return am - bm;
    if(a.master_id && b.master_id && a.master_id===b.master_id){
      var ar=a.year||0, br=b.year||0; if(ar!==br) return ar - br;
    }
   
