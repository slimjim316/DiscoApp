<!doctype html>
<html>
<head>
<meta charset="utf-8">
<meta name="viewport" content="width=device-width,initial-scale=1">
<title>DiscoApp · Library</title>
<style>
  /* ---------- Apple Music–style (light) ---------- */
  :root{
    --bg:#ffffff; --text:#111111; --muted:#6b6b6b;
    --hair:#e6e6e6; --red:#ff3b30; --tile:#f5f5f7;
  }
  *{box-sizing:border-box}
  html,body{height:100%}
  body{
    margin:0;background:var(--bg);color:var(--text);
    font-family:-apple-system,BlinkMacSystemFont,"Segoe UI",Roboto,Helvetica,Arial,sans-serif;
    -webkit-font-smoothing:antialiased; text-rendering:optimizeLegibility;
  }

  /* Top area */
  header{
    position:sticky; top:0; z-index:10; background:var(--bg);
    padding:8px 12px 6px 12px; border-bottom:1px solid var(--hair);
  }
  .title{font-size:28px;font-weight:700;margin:8px 2px 10px 2px;}
  .search{
    display:flex; align-items:center; gap:8px; background:var(--tile);
    border:1px solid var(--hair); padding:10px 12px; border-radius:12px;
  }
  .search input{flex:1;border:0;background:transparent;outline:none;font-size:16px;color:var(--text);}
  .search .mag{opacity:.6}
  .info{display:flex;justify-content:space-between;align-items:center;font-size:13px;color:var(--muted);padding:8px 2px 6px 2px;}

  /* Content area */
  main{padding:10px 10px 90px 10px;}

  /* ===== FLEXBOX GRID (bulletproof on iOS 12 & desktop) ===== */
  .grid{
    display:flex; flex-wrap:wrap; margin:-6px;   /* gutters via negative margins */
  }
  .card{
    width:calc(25% - 12px); margin:6px; border:1px solid var(--hair); border-radius:12px; background:var(--tile);
  }
  @media (max-width:1200px){ .card{ width:calc(33.333% - 12px);} }
  @media (max-width:800px){ .card{ width:calc(50% - 12px);} }
  @media (max-width:520px){ .card{ width:100%; } }
  .cardInner{display:flex;gap:10px;padding:10px}
  .artWrap{flex:0 0 72px; height:72px; border-radius:8px; overflow:hidden; background:#ddd;}
  .art{width:72px;height:72px;object-fit:cover;display:block;}
  .meta{display:flex;flex-direction:column;justify-content:center;gap:4px;min-width:0}
  .t{font-weight:600;white-space:nowrap;overflow:hidden;text-overflow:ellipsis}
  .s{font-size:13px;color:var(--muted);white-space:nowrap;overflow:hidden;text-overflow:ellipsis}

  /* ===== LIST VIEW ===== */
  .list{list-style:none;margin:0;padding:0;border:1px solid var(--hair); border-radius:12px; overflow:hidden;}
  .row{
    display:flex; align-items:center; gap:12px; padding:10px 12px; background:var(--bg);
    border-bottom:1px solid var(--hair);
  }
  .row:last-child{border-bottom:0}
  .thumbWrap{flex:0 0 48px; height:48px; border-radius:6px; overflow:hidden; background:#ddd;}
  .thumb{width:48px;height:48px;object-fit:cover;display:block;}
  .metaL{display:flex;flex-direction:column;gap:3px;min-width:0}
  .tL{font-weight:600;white-space:nowrap;overflow:hidden;text-overflow:ellipsis}
  .sL{font-size:13px;color:var(--muted);white-space:nowrap;overflow:hidden;text-overflow:ellipsis}

  /* Footer / controls */
  footer{
    position:fixed; left:0; right:0; bottom:0; background:var(--bg);
    border-top:1px solid var(--hair); padding:10px; display:flex; gap:10px; justify-content:space-between; align-items:center;
  }
  .controls{display:flex; gap:8px; align-items:center;}
  button{
    -webkit-appearance:none; appearance:none; font:inherit;
    background:var(--tile); border:1px solid var(--hair); padding:8px 12px; border-radius:10px; cursor:pointer;
  }
  button[disabled]{opacity:.5; cursor:default}
  .pill{font-size:13px;color:var(--muted)}

  /* Modal (details) */
  .modal.hidden{display:none}
  .modal{position:fixed; inset:0; background:rgba(0,0,0,.5); display:flex; align-items:center; justify-content:center; padding:18px;}
  .sheet{width:min(800px,96vw); max-height:90vh; background:var(--bg); border-radius:16px; overflow:hidden; display:flex; flex-direction:column; border:1px solid var(--hair);}
  .sheetHead{flex:0 0 auto; border-bottom:1px solid var(--hair); padding:10px 12px; display:flex; align-items:center; justify-content:space-between}
  .sheetTitle{font-weight:700}
  .sheetBody{overflow:auto}
  .hero{width:100%; max-height:360px; object-fit:cover; background:#ddd; display:block}
  .bodyPad{padding:12px}
  .metaRow{display:flex; gap:8px; align-items:center}
  .meta-row{color:var(--muted); font-size:14px; margin:3px 0;}

</style>
</head>
<body>
  <header>
    <div class="title">Library</div>
    <div class="search">
      <svg class="mag" width="18" height="18" viewBox="0 0 24 24" fill="none"><path d="M21 21l-4.35-4.35M10.5 18a7.5 7.5 0 1 1 0-15 7.5 7.5 0 0 1 0 15z" stroke="currentColor" stroke-width="2" stroke-linecap="round"/></svg>
      <input id="q" type="search" placeholder="Search library…">
    </div>
    <div class="info">
      <div id="count">0</div>
      <div class="pill">Page <span id="page">1</span></div>
    </div>
  </header>

  <main>
    <div id="grid" class="grid" aria-live="polite"></div>
    <ul id="list" class="list" aria-live="polite" style="display:none"></ul>
  </main>

  <footer>
    <div class="controls">
      <button id="prev">Prev</button>
      <button id="next">Next</button>
      <button id="random">Random</button>
    </div>
    <div class="controls">
      <button id="toggle">List View</button>
    </div>
  </footer>

  <!-- Details modal -->
  <div id="modal" class="modal hidden" aria-hidden="true" role="dialog" aria-modal="true">
    <div class="sheet">
      <div class="sheetHead">
        <div class="sheetTitle" id="md-title">Details</div>
        <button id="md-close" aria-label="Close">Close</button>
      </div>
      <div class="sheetBody">
        <img id="md-hero" class="hero" alt="">
        <div id="md-body" class="bodyPad"></div>
      </div>
    </div>
  </div>

<script>
(function(){
  /* ------------- CONFIG ------------- */
  var API  = "https://disco.slimjim316.workers.dev";  // your Worker URL
  var USER = "slimjim316";

  /* ------------- STATE -------------- */
  var page=1, per=100, folder=0, cache=[], total=0, pages=1, q="", view="grid";

  function get(url, cb){
    var x=new XMLHttpRequest();
    x.open("GET", url, true);
    x.onreadystatechange=function(){
      if(x.readyState===4){
        if(x.status>=200 && x.status<300){
          try{ cb(null, JSON.parse(x.responseText)); }
          catch(e){ cb(new Error("Bad JSON from API")); }
        }else{
          if(x.status===0) cb(new Error("Network/CORS error. Check API URL and no trailing slash."));
          else cb(new Error(x.status+" "+(x.responseText||x.statusText)));
        }
      }
    };
    x.onerror=function(){ cb(new Error("Request failed (possible CORS or offline).")); };
    x.send();
  }

  // ===== Master cache & sorting helpers (ES5) =====
  var MASTER_YEAR = {};   // { master_id: year }
  var MASTER_FETCHED = {}; // { master_id: true }

  function normalizeArtist(name){
    if(!name) return "";
    var s = String(name);
    s = s.replace(/^\s*the\s+/i, "");
    return s.toLowerCase();
  }

  function isVarious(name){
    return /^\s*various\s*$/i.test(name||"");
  }

  function fetchMaster(masterId, cb){
    if(!masterId){ if(cb) cb(null, null); return; }
    if(MASTER_YEAR.hasOwnProperty(masterId)){ if(cb) cb(null, MASTER_YEAR[masterId]); return; }
    if(MASTER_FETCHED[masterId]){ if(cb) cb(null, null); return; }
    MASTER_FETCHED[masterId] = true;
    get(API + "/api/master?id=" + encodeURIComponent(masterId), function(err, data){
      if(err){ if(cb) cb(null, null); return; }
      var y = (data && (data.year || data.released_year)) ? (data.year || data.released_year) : null;
      if(y!=null) MASTER_YEAR[masterId] = y;
      if(cb) cb(null, y);
    });
  }

  function fillMasterYears(items, onDone){
    var todo = [], seen = {};
    for(var i=0;i<items.length;i++){
      var m = items[i].master_id;
      if(m && !MASTER_YEAR.hasOwnProperty(m) && !MASTER_FETCHED[m] && !seen[m]){
        seen[m]=1; todo.push(m);
      }
    }
    if(!todo.length){ if(onDone) onDone(); return; }
    var left = todo.length;
    for(var j=0;j<todo.length;j++){
      (function(mid){
        fetchMaster(mid, function(){ left--; if(left===0 && onDone) onDone(); });
      })(todo[j]);
    }
  }

  function cmpItems(a,b){
    // 1) Artist A–Z (ignoring leading 'The ')
    if(a.normArtist < b.normArtist) return -1;
    if(a.normArtist > b.normArtist) return 1;

    // If both are Various -> sort by title A–Z
    var aVar = a.isVarious, bVar = b.isVarious;
    if(aVar && bVar){
      var at = (a.title||"").toLowerCase(), bt = (b.title||"").toLowerCase();
      if(at<bt) return -1; if(at>bt) return 1; return 0;
    }

    // 2) Master year (fallback to copy's release year if unknown)
    var am = (a.master_year!=null)?a.master_year:((a.year!=null)?a.year:null);
    var bm = (b.master_year!=null)?b.master_year:((b.year!=null)?b.year:null);
    if(am!=null && bm!=null && am!==bm) return am - bm;

    // 3) Same album (same master_id) -> sort by their own release year
    if(a.master_id && b.master_id && a.master_id === b.master_id){
      var ar = (a.year!=null)?a.year:0, br = (b.year!=null)?b.year:0;
      if(ar!==br) return ar - br;
    }

    // 4) Fallback title A–Z
    var aT=(a.title||"").toLowerCase(), bT=(b.title||"").toLowerCase();
    if(aT<bT) return -1; if(aT>bT) return 1; return 0;
  }

  function loadPage(p, cb){
    page=p;
    document.getElementById("page").textContent="Page "+page;
    var url = API + "/api/collection?username=" + encodeURIComponent(USER) +
              "&folder_id=" + folder + "&per_page=" + per + "&page=" + page +
              "&sort=artist&sort_order=asc";
    get(url, function(err, data){
      if(err){ alert(err.message); return; }
      total = data.pagination ? data.pagination.items : 0;
      pages = data.pagination ? data.pagination.pages : 1;
      cache = (data.releases||[]).map(function(r){
        var rel = r.basic_information||{};
        var artistName = (rel.artists && rel.artists[0] && rel.artists
