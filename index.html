<!doctype html>
<html>
<head>
<meta charset="utf-8">
<meta name="viewport" content="width=device-width,initial-scale=1">
<title>DiscoApp · Library</title>
<style>
  :root{ --bg:#ffffff; --text:#111111; --muted:#6b6b6b; --hair:#e6e6e6; --red:#ff3b30; --tile:#f5f5f7; }
  *{box-sizing:border-box} html,body{height:100%}
  body{ margin:0; background:var(--bg); color:var(--text);
    font-family:-apple-system,BlinkMacSystemFont,"Segoe UI",Roboto,Helvetica,Arial,sans-serif;
    -webkit-font-smoothing:antialiased; text-rendering:optimizeLegibility; }
  header{ position:sticky; top:0; z-index:10; background:var(--bg); padding:8px 12px 6px; border-bottom:1px solid var(--hair); }
  .title{font-size:28px;font-weight:700;margin:8px 2px 10px}
  .search{ display:flex; align-items:center; gap:8px; background:var(--tile); border:1px solid var(--hair); padding:10px 12px; border-radius:12px; }
  .search input{flex:1;border:0;background:transparent;outline:none;font-size:16px;color:var(--text)}
  .search .mag{opacity:.6}
  .info{display:flex;justify-content:space-between;align-items:center;font-size:13px;color:var(--muted);padding:8px 2px 6px}
  main{padding:10px 10px 90px}
  .grid{ display:flex; flex-wrap:wrap; margin:-6px; }
  .card{ width:20%; padding:6px; }
  .cardInner{ background:var(--bg); border:1px solid var(--hair); border-radius:12px; overflow:hidden; cursor:pointer; display:flex; flex-direction:column; height:100%;}
  .artWrap{position:relative;width:100%;padding-top:100%;background:#ddd;border-bottom:1px solid var(--hair)}
  .art{position:absolute;left:0;top:0;width:100%;height:100%;object-fit:cover;background:#ddd}
  .meta{padding:8px 10px;min-height:56px}
  .t{font-weight:700;font-size:14px;line-height:1.25;white-space:nowrap;overflow:hidden;text-overflow:ellipsis}
  .s{margin-top:2px;font-size:12px;color:var(--muted);white-space:nowrap;overflow:hidden;text-overflow:ellipsis}
  @media (max-width:1024px){ .card{width:25%} }
  @media (max-width:820px) { .card{width:33.3333%} }
  @media (max-width:600px) { .card{width:50%} }
  @media (max-width:380px) { .card{width:100%} }
  .list{list-style:none; padding:0; margin:0; display:none;}
  .row{display:flex; align-items:center; padding:10px 12px; border-bottom:1px solid var(--hair); cursor:pointer}
  .thumbWrap{position:relative; width:64px; height:64px; border-radius:8px; overflow:hidden; background:#ddd; margin-right:12px}
  .thumb{position:absolute; left:0; top:0; width:100%; height:100%; object-fit:cover; background:#ddd}
  .metaL{min-width:0}
  .tL{font-weight:700;font-size:16px;line-height:1.2;white-space:nowrap;overflow:hidden;text-overflow:ellipsis}
  .sL{margin-top:2px;font-size:13px;color:var(--muted);white-space:nowrap;overflow:hidden;text-overflow:ellipsis}
  .toolbar{ position:fixed; left:0; right:0; bottom:0; background:var(--bg); border-top:1px solid var(--hair);
    display:flex; gap:8px; align-items:center; justify-content:space-between; padding:10px 12px; }
  .group{display:flex; gap:8px; align-items:center}
  .btn{ border:1px solid var(--hair); background:var(--tile); color:var(--text); padding:8px 12px; border-radius:10px; font-size:15px; cursor:pointer }
  .btn:disabled{opacity:.5; cursor:not-allowed}
  .accent{border-color:var(--red); color:#fff; background:var(--red)}
  .modal{position:fixed; left:0; right:0; top:0; bottom:0; background:rgba(0,0,0,.35); display:flex; align-items:flex-end; justify-content:center}
  .modal.hidden{display:none}
  .sheet{ width:100%; max-width:720px; background:var(--bg); border-radius:16px 16px 0 0; border:1px solid var(--hair); border-bottom:0; max-height:90vh; overflow:auto; box-shadow:0 -10px 30px rgba(0,0,0,.15); }
  .drag{width:48px;height:5px;border-radius:999px;background:var(--hair);margin:8px auto}
  .hero{width:100%; max-height:360px; object-fit:cover; border-bottom:1px solid var(--hair); background:#ddd}
  #md-body{padding:14px 16px 18px 16px}
  #md-body h2{margin:4px 0 6px 0;font-size:20px}
  .meta-row{color:var(--muted);margin:4px 0}
  .section{margin:12px 0 6px 0;font-weight:700}
  .tracks{margin:6px 0 0 0;padding-left:18px}
  .tracks li{margin:3px 0}
  .link{display:inline-block;margin-top:10px;padding:8px 12px;border-radius:10px;border:1px solid var(--hair);background:var(--tile);text-decoration:none;color:var(--text)}
</style>
</head>
<body>

<header>
  <div class="title">Library</div>
  <div class="search">
    <span class="mag">🔎</span>
    <input id="q" placeholder="Artists, albums, catalog #, year" autocomplete="off">
  </div>
  <div class="info">
    <span id="count">0 items</span>
    <span id="page">Page 1</span>
  </div>
</header>

<main>
  <div id="grid" class="grid" aria-live="polite" style="display:block;"></div>
  <ul id="list" class="list" aria-live="polite"></ul>
</main>

<div class="toolbar">
  <div class="group">
    <button id="prev" class="btn">◀︎ Prev</button>
    <button id="next" class="btn">Next ▶︎</button>
    <button id="random" class="btn accent">🎲 Random</button>
  </div>
  <div class="group">
    <button id="toggle" class="btn">List View</button>
  </div>
</div>

<div id="modal" class="modal hidden" aria-hidden="true">
  <div class="sheet" role="dialog" aria-modal="true" aria-labelledby="md-title">
    <div class="drag"></div>
    <img id="md-hero" class="hero" alt="">
    <div id="md-body"></div>
  </div>
</div>

<script>
(function(){
  /* ---------- CONFIG ---------- */
  var API  = "https://disco.slimjim316.workers.dev";
  var USER = "slimjim316";

  /* ---------- STATE ---------- */
  var page=1, per=100, folder=0, cache=[], total=0, pages=1, q="", view="grid";

  /* ---------- AJAX (ES5) ---------- */
  function get(url, cb){
    var x=new XMLHttpRequest();
    x.open("GET", url, true);
    try { x.setRequestHeader('Accept','application/json'); } catch(e){}
    x.onreadystatechange=function(){
      if(x.readyState===4){
        if(x.status>=200 && x.status<300){
          var json=null, err=null;
          try{ json = JSON.parse(x.responseText); }
          catch(e){ err = new Error("Bad JSON from API"); }
          cb(err, json);
        }else{
          cb(new Error("HTTP "+x.status+" on "+url));
        }
      }
    };
    x.onerror=function(){ cb(new Error("Network/CORS error on "+url)); };
    x.send();
  }

  /* ---------- Utils ---------- */
  function isArray(x){ return Object.prototype.toString.call(x) === '[object Array]'; }
  function escapeHtml(s){ return String(s).replace(/[&<>"']/g,function(m){return {'&':'&amp;','<':'&lt;','>':'&gt;','"':'&quot;',"'":'&#39;'}[m];}); }
  function openModal(){ var m=document.getElementById("modal"); m.className="modal"; m.setAttribute("aria-hidden","false"); }
  function closeModal(){ var m=document.getElementById("modal"); m.className="modal hidden"; m.setAttribute("aria-hidden","true");
    document.getElementById("md-body").innerHTML=""; document.getElementById("md-hero").src=""; }

  /* ---------- Master-year cache & sort helpers ---------- */
  var MASTER_YEAR = {};    // { master_id: year }
  var MASTER_FETCHED = {}; // { master_id: true }
  var CONCURRENCY = 6, inflight = 0, queue = [];

  function normalizeArtist(name){
    if(!name) return "";
    var s = String(name).replace(/^\s*the\s+/i, ""); // strip leading "The "
    return s.toLowerCase();
  }
  function isVarious(name){ return /^\s*various\s*$/i.test(name||""); }

  function parseYearFromMaster(data){
    if(!data) return null;
    if(typeof data.year === "number") return data.year;
    if(typeof data.year === "string" && /^\d{4}$/.test(data.year)) return +data.year;
    var r = data.released || data.released_date || "";
    var m = /^(\d{4})/.exec(r);
    return m ? +m[1] : null;
  }

  function runQueue(){
    while(inflight<CONCURRENCY && queue.length){
      var job = queue.shift();
      inflight++;
      job(function(){ inflight--; runQueue(); });
    }
  }

  // Fetch the Discogs master doc; prefer provided master_url, fall back to /masters/{id}
  function fetchMaster(masterId, masterUrl, cb){
    if(!masterId){ cb(null,null); return; }
    if(MASTER_YEAR.hasOwnProperty(masterId)){ cb(null, MASTER_YEAR[masterId]); return; }
    if(MASTER_FETCHED[masterId]){ cb(null,null); return; }
    MASTER_FETCHED[masterId]=true;

    var urls = [];
    if(masterUrl) urls.push(masterUrl);
    urls.push("https://api.discogs.com/masters/" + encodeURIComponent(masterId));

    queue.push(function(done){
      (function tryAt(i){
        if(i>=urls.length){ console.warn("[master] all failed for id", masterId); done(); cb(null,null); return; }
        var u = urls[i];
        console.log("[master] GET", u);
        get(u, function(err, data){
          if(err){
            console.warn("[master] ERR", u, String(err && err.message || err));
            tryAt(i+1);
            return;
          }
          var y = parseYearFromMaster(data);
          console.log("[master] OK", u, "year=", y);
          if(y!=null){
            MASTER_YEAR[masterId]=y;
            done(); cb(null, y);
          }else{
            console.warn("[master] No year in response", u, data);
            tryAt(i+1);
          }
        });
      })(0);
    });
    runQueue();
  }

  function fillMasterYears(items, onDone){
    var wanted=[], seen={};
    for(var i=0;i<items.length;i++){
      var it=items[i], m=it.master_id;
      if(m && !MASTER_YEAR.hasOwnProperty(m) && !MASTER_FETCHED[m] && !seen[m]){
        seen[m]=1; wanted.push({id:m, url:it.master_url});
      }
    }
    if(!wanted.length){ if(onDone) onDone(); return; }

    var left=wanted.length;
    for(var j=0;j<wanted.length;j++){
      (function(mid, murl){
        fetchMaster(mid, murl, function(){ left--; if(left===0 && onDone) onDone(); });
      })(wanted[j].id, wanted[j].url);
    }
  }

  function cmpItems(a,b){
    // 1) Artist A–Z (ignore "The ")
    if(a.normArtist < b.normArtist) return -1;
    if(a.normArtist > b.normArtist) return 1;

    // 1b) If both “Various”, title A–Z
    if(a.isVarious && b.isVarious){
      var at=(a.title||"").toLowerCase(), bt=(b.title||"").toLowerCase();
      if(at<bt) return -1; if(at>bt) return 1; return 0;
    }

    // 2) Master year (fallback to copy’s release year)
    var am = a.master_year!=null ? a.master_year : (a.year!=null ? a.year : null);
    var bm = b.master_year!=null ? b.master_year : (b.year!=null ? b.year : null);
    if(am!=null && bm!=null && am!==bm) return am - bm;

    // 3) Same master → sort by each copy’s release year
    if(a.master_id && b.master_id && a.master_id===b.master_id){
      var ar=a.year||0, br=b.year||0;
      if(ar!==br) return ar - br;
    }

    // 4) Fallback: title A–Z
    var aT=(a.title||"").toLowerCase(), bT=(b.title||"").toLowerCase();
    if(aT<bT) return -1; if(aT>bT) return 1; return 0;
  }

  /* ---------- Load & render ---------- */
  function loadPage(p, cb){
    page=p;
    document.getElementById("page").textContent="Page "+page;

    var url = API + "/api/collection?username=" + encodeURIComponent(USER) +
              "&folder_id=" + folder + "&per_page=" + per + "&page=" + page +
              "&sort=artist&sort_order=asc";

    get(url, function(err, data){
      if(err){ alert(err.message); return; }

      // Prefer Discogs 'releases'; fallback if Worker changes shape
      var arr = [];
      if(data){
        if(isArray(data.releases))      arr = data.releases;
        else if(isArray(data.items))     arr = data.items;
        else if(isArray(data.results))   arr = data.results;
        else if(isArray(data))           arr = data;
      }

      total = (data && data.pagination && data.pagination.items) ? data.pagination.items : (arr.length||0);
      pages = (data && data.pagination && data.pagination.pages) ? data.pagination.pages : (total ? Math.ceil(total/per) : 1);

      cache = arr.map(function(r){
        var info = r && r.basic_information ? r.basic_information : r || {};
        var artistsArr = info.artists || [];
        var firstArtist = artistsArr[0] && artistsArr[0].name ? artistsArr[0].name : (info.artist || "");
        var lbls = info.labels || [];
        var firstLbl = lbls[0] || {};
        var mid = info.master_id || r.master_id || null;
        var norm = normalizeArtist(firstArtist);

        return {
          id: info.id || r.id,
          title: info.title || "",
          artist: firstArtist,
          normArtist: isVarious(firstArtist) ? "various" : norm,
          isVarious: isVarious(firstArtist),
          year: (typeof info.year === "number" || typeof info.year === "string") ? info.year : null,
          master_id: mid,
          master_url: info.master_url || (mid ? ("https://api.discogs.com/masters/"+mid) : null),
          master_year: (mid && MASTER_YEAR[mid]!=null) ? MASTER_YEAR[mid] : null,
          catno: firstLbl.catno || info.catno || "",
          thumb: info.cover_image || info.thumb || ""
        };
      });

      // Initial render (uses whatever master years we already have)
      cache.sort(cmpItems);
      render();

      // Fetch missing master years → re-sort → render
      fillMasterYears(cache, function(){
        var changed=false, i;
        for(i=0;i<cache.length;i++){
          var it=cache[i];
          if(it.master_id && it.master_year==null && MASTER_YEAR.hasOwnProperty(it.master_id)){
            it.master_year = MASTER_YEAR[it.master_id];
            changed=true;
          }
        }
        if(changed){
          cache.sort(cmpItems);
          render();
        }
        if(typeof cb==="function") cb();
      });
    });
  }

  function matches(it, needle){
    if(!needle) return true;
    needle = String(needle).toLowerCase();
    return (it.title||"").toLowerCase().indexOf(needle)>-1 ||
           (it.artist||"").toLowerCase().indexOf(needle)>-1 ||
           String(it.year||"").indexOf(needle)>-1 ||
           String(it.catno||"").toLowerCase().indexOf(needle)>-1;
  }

  function render(){
    var grid=document.getElementById("grid");
    var list=document.getElementById("list");
    grid.innerHTML=""; list.innerHTML="";

    var filtered=[], i;
    for(i=0;i<cache.length;i++){ if(matches(cache[i], q)) filtered.push(cache[i]); }
    document.getElementById("count").textContent = filtered.length+" of "+cache.length+" (total "+total+")";

    if(view==="grid"){
      grid.style.display="flex"; list.style.display="none";
      for(i=0;i<filtered.length;i++){
        var it=filtered[i];
        var card=document.createElement("div"); card.className="card";
        var inner=document.createElement("div"); inner.className="cardInner";
        var wrap=document.createElement("div"); wrap.className="artWrap";
        var img=document.createElement("img"); img.className="art"; img.alt=""; img.src=it.thumb||"";
        wrap.appendChild(img);
        var meta=document.createElement("div"); meta.className="meta";
        var t=document.createElement("div"); t.className="t"; t.textContent=it.title;

        // ---- Show Artist • ReleaseYear • MasterYear (debug visible) ----
        var parts=[it.artist];
        if(it.year!=null && it.year!=="") parts.push(it.year);
        if(it.master_year!=null && it.master_year!=="") parts.push(it.master_year);
        var s=document.createElement("div"); s.className="s"; s.textContent=parts.join(" • ");

        meta.appendChild(t); meta.appendChild(s);
        inner.appendChild(wrap); inner.appendChild(meta);
        card.appendChild(inner);
        card.addEventListener("click",(function(id){return function(){showDetailsById(id);};})(it.id));
        grid.appendChild(card);
      }
    }else{
      grid.style.display="none"; list.style.display="block";
      for(i=0;i<filtered.length;i++){
        var it2=filtered[i];
        var li=document.createElement("li"); li.className="row";
        var tw=document.createElement("div"); tw.className="thumbWrap";
        var th=document.createElement("img"); th.className="thumb"; th.alt=""; th.src=it2.thumb||"";
        tw.appendChild(th);
        var metaL=document.createElement("div"); metaL.className="metaL";
        var tL=document.createElement("div"); tL.className="tL"; tL.textContent=it2.title;

        // ---- Show Artist • ReleaseYear • MasterYear • CatNo ----
        var p2=[it2.artist];
        if(it2.year!=null && it2.year!=="") p2.push(it2.year);
        if(it2.master_year!=null && it2.master_year!=="") p2.push(it2.master_year);
        if(it2.catno) p2.push(it2.catno);
        var sL=document.createElement("div"); sL.className="sL"; sL.textContent=p2.join(" • ");

        metaL.appendChild(tL); metaL.appendChild(sL);
        li.appendChild(tw); li.appendChild(metaL);
        li.addEventListener("click",(function(id){return function(){showDetailsById(id);};})(it2.id));
        list.appendChild(li);
      }
    }

    document.getElementById("prev").disabled = page<=1;
    document.getElementById("next").disabled = page>=pages;
    document.getElementById("toggle").textContent = (view==="grid") ? "List View" : "Grid View";
  }

  /* ---------- Details ---------- */
  function fetchRelease(id, cb){ get(API + "/api/release?id=" + encodeURIComponent(id), cb); }

  function showDetails(release){
    var body=document.getElementById("md-body"), hero=document.getElementById("md-hero");
    var title=release.title||"", artists=(release.artists&&release.artists[0]?release.artists[0].name:"");
    var year=release.year||"", lbl=(release.labels&&release.labels[0]?release.labels[0].name:"");
    var cat=(release.labels&&release.labels[0]?release.labels[0].catno:""), country=release.country||"";
    var fmts=(release.formats&&release.formats[0]?release.formats[0].name:"");
    var genres=(release.genres?release.genres.join(", "):"");
    var styles=(release.styles?release.styles.join(", "):"");
    var notes=release.notes||"";
    var art=(release.images&&release.images[0]?release.images[0].uri:"");
    hero.src = art || "";

    var html='';
    html+='<h2 id="md-title">'+escapeHtml(title)+'</h2>';
    html+='<div class="meta-row">'+escapeHtml(artists)+(year?" • "+year:"")+'</div>';
    html+='<div class="meta-row">'+(lbl?escapeHtml(lbl):"")+(cat?" • "+escapeHtml(cat):"")+(country?" • "+escapeHtml(country):"")+'</div>';
    if(release.master_id && MASTER_YEAR[release.master_id]!=null){
      html+='<div class="meta-row">Master released: '+MASTER_YEAR[release.master_id]+'</div>';
    }
    if(fmts)   html+='<div class="meta-row">Format: '+escapeHtml(fmts)+'</div>';
    if(genres) html+='<div class="meta-row">Genres: '+escapeHtml(genres)+'</div>';
    if(styles) html+='<div class="meta-row">Styles: '+escapeHtml(styles)+'</div>';
    if(release.tracklist&&release.tracklist.length){
      html+='<div class="section">Tracklist</div><ol class="tracks">';
      for(var i=0;i<release.tracklist.length;i++){
        var t=release.tracklist[i], nm=t.title||"", pos=t.position||"", dur=t.duration||"";
        html+='<li>'+escapeHtml((pos?pos+" – ":"")+nm+(dur?" ("+dur+")":""))+'</li>';
      }
      html+='</ol>';
    }
    if(notes){ html+='<div class="section">Notes</div><div style="white-space:pre-wrap">'+escapeHtml(notes)+'</div>'; }
    if(release.uri){ html+='<a class="link" target="_blank" rel="noopener" href="'+release.uri+'">View on Discogs</a>'; }
    body.innerHTML = html; openModal();
  }

  function showDetailsById(id){
    fetchRelease(id, function(err, data){
      if(err){ alert("Could not load details: " + err.message); return; }
      showDetails(data);
    });
  }

  /* ---------- Controls ---------- */
  function openRandom(){
    if(!total){ alert("Collection not loaded yet."); return; }
    var idx=Math.floor(Math.random()*total)+1;
    var targetPage=Math.ceil(idx/per);
    var indexOnPage=(idx-1)%per;
    if(page===targetPage && cache[indexOnPage]){
      showDetailsById(cache[indexOnPage].id); return;
    }
    loadPage(targetPage, function(){
      if(cache[indexOnPage]) showDetailsById(cache[indexOnPage].id);
      else alert("Random pick failed");
    });
  }

  document.getElementById("q").addEventListener("input", function(e){ q=e.target.value; render(); });
  document.getElementById("prev").addEventListener("click", function(){ if(page>1) loadPage(page-1); });
  document.getElementById("next").addEventListener("click", function(){ if(page<pages) loadPage(page+1); });
  document.getElementById("random").addEventListener("click", openRandom);
  document.getElementById("toggle").addEventListener("click", function(){ view=(view==="grid")?"list":"grid"; render(); });
  document.getElementById("modal").addEventListener("click", function(e){ if(e.target && e.target.id==="modal") closeModal(); });

  /* ---------- Boot ---------- */
  loadPage(1);
})();
</script>
</body>
</html>
